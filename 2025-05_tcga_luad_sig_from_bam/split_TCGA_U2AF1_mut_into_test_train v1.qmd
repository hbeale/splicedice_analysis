---
title: "`r gsub('.Rmd', ' ', gsub('_', ' ', knitr::current_input()))`"
author: "Holly Beale"
date: "`r format(Sys.time(), '%B %d, %Y')`"
format: 
  gfm:
    df-print: kable
---

```{r}
library(tidyverse)
library(janitor)
```

# Set up input data
## Load previous manifest
```{r}
all_93_samples_sig_manifest <- 
read_tsv("/mnt/data/manifests/batches_1_and_2_sig_manifest.all_dashes.with_genotypes.2025.05.29_22.26.44.tsv",
         col_names = c("id", "genotype"))
```
## define output dir
```{r}

this_output_dir <- "tcga_batches_1_and_2_2025.06.05_train_test/"
base_output_path <- "/mnt/output/splicedice/"

this_full_output_path <- file.path(base_output_path, this_output_dir)

if (! file.exists (this_full_output_path)) dir.create(this_full_output_path)
    
list.files(this_full_output_path)

```

## Select train/test sets
```{r}
tabyl(all_93_samples_sig_manifest,
      genotype)


## decision, train on 7 u2af1-s34f (64%, 7/11), test on 4
## correspondingly, train on 52 u2af1-wt  (63%, 52/82), test on 30

set.seed(59566)
train_samples <- all_93_samples_sig_manifest  %>%
  group_by(genotype) %>%
  sample_frac(0.63)

tabyl(train_samples,
      genotype)


test_samples <- anti_join(all_93_samples_sig_manifest, 
                          train_samples, 
                          by = 'id')

tabyl(test_samples,
      genotype)

```
## Make train dataset
```{r}

write_tsv(train_samples,
          "/mnt/data/manifests/batches_1_and_2_sig_manifest.59_test.samples_2025.05.29_22.26.44.tsv",
          col_names = FALSE)

```

## Create PS file with only test samples 
note: set na = "nan" to be consistent with data generated by splicedice
```{r}

allPS <- read_tsv("/mnt/output/splicedice/tcga_batches_1_and_2_2025.05.29/batches_1_and_2.all_dash_ids.2025.05.29_22.26.44_allPS.tsv")

test_ps <- allPS %>%
  select(cluster, test_samples$id)

write_tsv(test_ps, 
          file.path(base_output_path, "test_allPS.dash_ids.tsv"),
          na = "nan")

```

## Confirm genotypes in test and train sets
```{r}

# are all test sample IDs in test ps?
all(test_samples$id %in% colnames(test_ps))

# are any mutant sample IDs in both the test and the training sets?
any(test_samples$id %in% train_samples$id)
any(train_samples$id %in% test_samples$id)


```

# generate signature
```{r}


sig_command <- "
; echo $sig_script
source_dir=/mnt/output/splicedice/tcga_batches_1_and_2_2025.05.29/; echo $source_dir
allPS_file=${source_dir}/batches_1_and_2_bed_manifest.with_genotypes.2025.05.29_22.26.44_allPS.tsv 
out_dir=/mnt/output/splicedice/tcga_batches_1_and_2_2025.06.04_train_test/

time python3 $sig_script compare -p $allPS_file -m $sig_manfiest -o $out_dir
~/alertme.sh"

cat(sig_command)

system( command = sig_command,
         intern = TRUE)

```
## review sig
```{r}

sig <- read_tsv("/mnt/output/splicedice/tcga_batches_1_and_2_2025.06.04_train_test/.sig.tsv")

head(sig)

```


# Fit beta
```{r}

Sys.setenv(
  sig_script = 
    "/mnt/code/dennisrm_splicedice/splicedice/code/signature.py")

Sys.setenv(
  sig_manfiest = 
    "/mnt/data/manifests/batches_1_and_2_sig_manifest.59_test.samples_2025.05.29_22.26.44.tsv")


Sys.setenv(
  allPS_file=
    "/mnt/output/splicedice/tcga_batches_1_and_2_2025.05.29/batches_1_and_2.all_dash_ids.2025.05.29_22.26.44_allPS.tsv")

Sys.setenv(
  out_dir = 
    this_full_output_path)


beta_command <- "
date
echo python3 $sig_script fit_beta -p $allPS_file -s ${out_dir}/.sig.tsv -m $sig_manfiest -o $out_dir
head $out_dir/.beta.tsv
date"
#~/alertme.sh"

cat(beta_command)


system( command = beta_command, intern = TRUE)

```



## review beta
```{r}

beta_result <- read_tsv(file.path(this_full_output_path, ".beta.tsv"))

head(beta_result)

```

# Query with test set
```{r}
query_command <- "
out_dir=/mnt/output/splicedice/tcga_batches_1_and_2_2025.06.04_train_test
sig_script=/mnt/code/dennisrm_splicedice/splicedice/code/signature.py; echo $sig_script
test_PS=${out_dir}/test_allPS.dash_ids.tsv
beta_file=${out_dir}/.beta.tsv
time python3 $sig_script query -p $test_PS -b $beta_file -o ${out_dir}/find_u2af1_s34f_sig_in_test_set
~/alertme.sh"

cat(query_command)

system( command = query_command, intern = TRUE)


```

## review results
```{r}

query_result <- read_tsv("/mnt/output/splicedice/tcga_batches_1_and_2_2025.06.04_train_test/find_u2af1_s34f_sig_in_test_set.pvals.tsv")

head(query_result)

query_result_longer <- query_result %>%
  pivot_longer(-query,
               names_to = "id",
               values_to = "pvalue") %>%
  mutate(pvalue_rounded = round(pvalue, 2))


query_result_longer_with_genotypes <- query_result_longer %>%
  filter(query == "u2af1-s34f_over_u2af1-wt") %>%
  rename(pvalue_for_u2af1_s34f_match = pvalue) %>%
  left_join(all_93_samples_sig_manifest,
            by = join_by(id))



```

# Did query results reflect genotypes?
```{r}
ggplot(query_result_longer_with_genotypes) +
  geom_histogram(aes(x=pvalue_for_u2af1_s34f_match, fill = genotype),
                 bins = 20) +
  scale_fill_brewer(palette = "Set1")
```

```{r}
query_result_longer_with_genotypes %>%
  filter(genotype == "u2af1-s34f",
         pvalue_rounded == 1)


```

